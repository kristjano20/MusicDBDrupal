<?php

use Drupal\Core\Form\FormStateInterface;


function music_db_form_node_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  $node = $form_state->getFormObject()->getEntity();
  if ($node->bundle() !== 'artist') {
    return;
  }

  if (!isset($form['title']['widget'][0]['value'])) {
    return;
  }

  $title_element = &$form['title']['widget'][0]['value'];
  $title_element['#autocomplete_route_name'] = 'music_db.spotify_artist_autocomplete';
  $title_element['#autocomplete_route_parameters'] = [];
  $title_element['#description'] = t('Start typing to search Spotify and pick the correct artist.');
}


/**
 * Helper function to alter forms with autocomplete functionality.
 */
function _music_db_alter_form_with_autocomplete(array &$form, FormStateInterface $form_state, string $entity_type): void {
  $form['#attached']['library'][] = 'music_db/autocomplete_provider';
  $form['#attributes']['data-music-db-autocomplete-type'] = $entity_type;

  $entity = $form_state->getFormObject()->getEntity();
  $provider = \Drupal\music_db\Helper\FormHelper::getProviderValue($form, $form_state, $entity);

  \Drupal\music_db\Helper\FormHelper::setAutocompleteOnNameField($form, $provider, $entity_type);
  \Drupal\music_db\Helper\FormHelper::setAjaxOnProviderField($form);
  \Drupal\music_db\Helper\FormHelper::wrapNameField($form);
}

function music_db_form_artist_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  _music_db_alter_form_with_autocomplete($form, $form_state, 'artist');
}

function music_db_form_album_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  _music_db_alter_form_with_autocomplete($form, $form_state, 'album');
}

function music_db_form_song_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  _music_db_alter_form_with_autocomplete($form, $form_state, 'song');
}

function music_db_autocomplete_provider_ajax_callback(array &$form, FormStateInterface $form_state) {
  $provider = \Drupal\music_db\Helper\FormHelper::getProviderValue($form, $form_state);
  $form_type = $form['#attributes']['data-music-db-autocomplete-type'] ?? 'artist';
  \Drupal\music_db\Helper\FormHelper::setAutocompleteOnNameField($form, $provider, $form_type);
  \Drupal\music_db\Helper\FormHelper::wrapNameField($form);

  $name_field = \Drupal\music_db\Helper\FormHelper::getNameField($form);
  return $name_field ?: ['#markup' => '<div id="autocomplete-name-wrapper"></div>'];
}
